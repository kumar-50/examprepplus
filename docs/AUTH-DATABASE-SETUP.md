# üîó Linking Supabase Auth to Users Table - SETUP GUIDE

## The Problem You're Experiencing

When you sign up, users are created in:
- ‚úÖ `auth.users` (Supabase's auth system) 
- ‚ùå `public.users` (your app's users table) ‚Üê **MISSING!**

This happens because the **database triggers** haven't been applied yet.

## How The Link Works

```
User Signs Up
    ‚Üì
Supabase creates record in auth.users
    ‚Üì
üî• TRIGGER fires: on_auth_user_created
    ‚Üì
üìù Function runs: handle_new_user()
    ‚Üì
‚úÖ Record created in public.users with SAME ID
```

## üöÄ Fix This In 3 Steps

### Step 1: Open Supabase SQL Editor

1. Go to https://supabase.com/dashboard
2. Select your project
3. Click **SQL Editor** in left sidebar
4. Click **New Query**

### Step 2: Apply the Triggers

Copy and paste ALL of this SQL and click **RUN**:

```sql
-- Create function to sync new users
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.users (id, email, full_name, created_at, updated_at)
  VALUES (
    new.id,
    new.email,
    COALESCE(new.raw_user_meta_data->>'full_name', ''),
    now(),
    now()
  )
  ON CONFLICT (id) DO NOTHING;
  RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Create trigger
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();

-- Create function for login tracking
CREATE OR REPLACE FUNCTION public.handle_user_login()
RETURNS TRIGGER AS $$
BEGIN
  UPDATE public.users
  SET last_login_at = now()
  WHERE id = new.user_id;
  RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Create login trigger
DROP TRIGGER IF EXISTS on_user_login ON auth.sessions;
CREATE TRIGGER on_user_login
  AFTER INSERT ON auth.sessions
  FOR EACH ROW EXECUTE FUNCTION public.handle_user_login();
```

**Expected Output:** ‚úÖ "Success. No rows returned"

### Step 3: Sync Existing Users

If you already created users BEFORE applying triggers, run this:

```sql
-- Sync existing auth users to public.users
INSERT INTO public.users (id, email, full_name, created_at, updated_at)
SELECT 
  au.id,
  au.email,
  COALESCE(au.raw_user_meta_data->>'full_name', ''),
  au.created_at,
  now()
FROM auth.users au
ON CONFLICT (id) DO UPDATE SET
  email = EXCLUDED.email,
  full_name = EXCLUDED.full_name,
  updated_at = now();
```

**Expected Output:** Shows number of rows inserted/updated

## üß™ Verify It's Working

### Test 1: Check Triggers Were Created

```sql
SELECT trigger_name, event_object_table 
FROM information_schema.triggers 
WHERE trigger_name IN ('on_auth_user_created', 'on_user_login');
```

**Should return:**
| trigger_name | event_object_table |
|--------------|-------------------|
| on_auth_user_created | users |
| on_user_login | sessions |

### Test 2: Check Existing Users Are Synced

```sql
SELECT 
  (SELECT COUNT(*) FROM auth.users) as auth_count,
  (SELECT COUNT(*) FROM public.users) as users_count;
```

**Both counts should be EQUAL!**

### Test 3: View Your Users

```sql
SELECT 
  u.id,
  u.email,
  u.full_name,
  u.role,
  u.subscription_status,
  u.created_at
FROM public.users u
ORDER BY u.created_at DESC;
```

### Test 4: Create a New User

1. Sign up with a NEW email in your app
2. Run this query:

```sql
-- Check both tables
SELECT 'auth.users' as table_name, id, email, created_at 
FROM auth.users 
WHERE email = 'your-new-email@test.com'
UNION ALL
SELECT 'public.users' as table_name, id::text, email, created_at 
FROM public.users 
WHERE email = 'your-new-email@test.com';
```

**Should see 2 rows** - one from each table with SAME ID!

## üéØ Make Someone an Admin

After syncing, make yourself admin:

```sql
-- Replace with your email
UPDATE public.users 
SET role = 'admin' 
WHERE email = 'your@email.com';

-- Verify
SELECT email, role FROM public.users WHERE role = 'admin';
```

## üîç Understanding the Code

### The User ID Link

The **critical link** is the `id` field:

```typescript
// In auth.users
{
  id: "uuid-123-456",  // ‚Üê Generated by Supabase Auth
  email: "user@test.com"
}

// In public.users (same ID!)
{
  id: "uuid-123-456",  // ‚Üê SAME ID from auth.users
  email: "user@test.com",
  role: "user"
}
```

### How My Code Uses This

**Server-side (Admin Protection):**
```typescript
// src/lib/auth/server.ts
export async function requireAdmin() {
  // 1. Get authenticated user from Supabase Auth
  const user = await getCurrentUser()  // Gets from auth.users
  
  // 2. Get profile from public.users using SAME ID
  const profile = await getUserProfile(user.id)  // Query: WHERE id = user.id
  
  // 3. Check role from public.users
  if (profile?.role !== 'admin') {
    throw new Error('Forbidden')
  }
}
```

**Client-side (Display User Info):**
```typescript
// src/hooks/use-session-user.ts
const { user } = useSessionUser()  // Gets from auth.users via Supabase client

// User has basic info from auth:
user.id           // The ID that links to public.users
user.email        
user.user_metadata.full_name
```

## ‚ùì FAQ

**Q: Why have both tables?**
- `auth.users` - Managed by Supabase, handles authentication
- `public.users` - Your app's data, includes role, subscription, etc.

**Q: What if the trigger fails?**
- User will be in `auth.users` but NOT in `public.users`
- Admin routes will fail (can't find user profile)
- Use the sync script to fix

**Q: Can I just use auth.users?**
- No, you can't add custom columns to `auth.users`
- You can't set RLS policies on `auth.users`
- That's why we have `public.users`

**Q: When does the trigger run?**
- Automatically when someone signs up
- Automatically when someone signs in (for last_login_at)
- NOT for existing users (use sync script)

## üö® Troubleshooting

**Error: "relation auth.users does not exist"**
- You're not connected to the right database
- Make sure you're in Supabase SQL Editor, not local psql

**Users still not syncing**
- Check trigger exists: `\dS auth.users` or use verification query
- Check function exists: `\df public.handle_new_user`
- Check Supabase logs for errors

**Can't set user as admin**
- Make sure public.users table has the user
- Run sync script first
- Check spelling of email address

## ‚úÖ Success Checklist

- [ ] Applied triggers in Supabase SQL Editor
- [ ] Ran sync script for existing users
- [ ] Verified trigger creation
- [ ] Verified user counts match
- [ ] Created new test user - appears in both tables
- [ ] Set at least one user as admin
- [ ] Can access /admin route as admin
- [ ] Regular users blocked from /admin

---

**Files you need:**
- `migrations/APPLY-THIS-TO-SUPABASE.sql` - Apply triggers
- `migrations/sync-existing-users.sql` - Sync existing users
