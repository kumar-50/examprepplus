'use client'

import { useState, useEffect } from 'react'
import { Button } from '@/components/ui/button'
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from '@/components/ui/card'
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import {
  Sheet,
  SheetContent,
  SheetDescription,
  SheetFooter,
  SheetHeader,
  SheetTitle,
} from '@/components/ui/sheet'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Textarea } from '@/components/ui/textarea'
import { Badge } from '@/components/ui/badge'
import { Plus, Pencil, Trash2, ChevronLeft, ChevronRight, Upload } from 'lucide-react'
import { useToast } from '@/hooks/use-toast'
import Link from 'next/link'

interface Section {
  id: string
  name: string
}

interface Topic {
  id: string
  name: string
  sectionId: string
}

interface Question {
  id: string
  questionText: string
  option1: string
  option2: string
  option3: string
  option4: string
  correctOption: number
  explanation: string | null
  sectionId: string
  topicId: string | null
  difficultyLevel: 'easy' | 'medium' | 'hard'
  hasEquation: boolean
  imageUrl: string | null
  isActive: boolean
  createdAt: string
}

interface QuestionFormData {
  questionText: string
  option1: string
  option2: string
  option3: string
  option4: string
  correctOption: number
  explanation: string
  sectionId: string
  topicId: string
  difficultyLevel: 'easy' | 'medium' | 'hard'
  hasEquation: boolean
  imageUrl: string
  isActive: boolean
}

export default function QuestionsPage() {
  const [sections, setSections] = useState<Section[]>([])
  const [topics, setTopics] = useState<Topic[]>([])
  const [questions, setQuestions] = useState<Question[]>([])
  const [isLoading, setIsLoading] = useState(true)
  const [isSheetOpen, setIsSheetOpen] = useState(false)
  const [editingQuestion, setEditingQuestion] = useState<Question | null>(null)
  
  // Filters
  const [filterSection, setFilterSection] = useState('')
  const [filterTopic, setFilterTopic] = useState('')
  const [filterDifficulty, setFilterDifficulty] = useState('')
  
  // Pagination
  const [currentPage, setCurrentPage] = useState(1)
  const [totalPages, setTotalPages] = useState(1)
  const [total, setTotal] = useState(0)
  const pageSize = 20

  const [formData, setFormData] = useState<QuestionFormData>({
    questionText: '',
    option1: '',
    option2: '',
    option3: '',
    option4: '',
    correctOption: 1,
    explanation: '',
    sectionId: '',
    topicId: '',
    difficultyLevel: 'medium',
    hasEquation: false,
    imageUrl: '',
    isActive: true,
  })
  const [isSubmitting, setIsSubmitting] = useState(false)
  const { toast } = useToast()

  useEffect(() => {
    fetchSections()
  }, [])

  useEffect(() => {
    fetchQuestions()
  }, [currentPage, filterSection, filterTopic, filterDifficulty])

  useEffect(() => {
    if (filterSection) {
      fetchTopics(filterSection)
    }
  }, [filterSection])

  const fetchSections = async () => {
    try {
      const response = await fetch('/api/admin/sections')
      if (!response.ok) throw new Error('Failed to fetch sections')
      const data = await response.json()
      setSections(data.sections)
    } catch (error) {
      toast({
        title: 'Error',
        description: 'Failed to load sections',
        variant: 'destructive',
      })
    }
  }

  const fetchTopics = async (sectionId: string) => {
    try {
      const response = await fetch(`/api/admin/topics?sectionId=${sectionId}`)
      if (!response.ok) throw new Error('Failed to fetch topics')
      const data = await response.json()
      setTopics(data.topics)
    } catch (error) {
      toast({
        title: 'Error',
        description: 'Failed to load topics',
        variant: 'destructive',
      })
    }
  }

  const fetchQuestions = async () => {
    setIsLoading(true)
    try {
      const params = new URLSearchParams({
        page: currentPage.toString(),
        limit: pageSize.toString(),
      })
      
      if (filterSection) params.append('sectionId', filterSection)
      if (filterTopic) params.append('topicId', filterTopic)
      if (filterDifficulty) params.append('difficulty', filterDifficulty)

      const response = await fetch(`/api/admin/questions?${params}`)
      if (!response.ok) throw new Error('Failed to fetch questions')
      const data = await response.json()
      
      setQuestions(data.questions)
      setTotalPages(data.pagination.totalPages)
      setTotal(data.pagination.total)
    } catch (error) {
      toast({
        title: 'Error',
        description: 'Failed to load questions',
        variant: 'destructive',
      })
    } finally {
      setIsLoading(false)
    }
  }

  const handleOpenDialog = async (question?: Question) => {
    if (question) {
      setEditingQuestion(question)
      setFormData({
        questionText: question.questionText,
        option1: question.option1,
        option2: question.option2,
        option3: question.option3,
        option4: question.option4,
        correctOption: question.correctOption,
        explanation: question.explanation || '',
        sectionId: question.sectionId,
        topicId: question.topicId || '',
        difficultyLevel: question.difficultyLevel,
        hasEquation: question.hasEquation,
        imageUrl: question.imageUrl || '',
        isActive: question.isActive,
      })
      // Load topics for the section
      if (question.sectionId) {
        await fetchTopics(question.sectionId)
      }
    } else {
      setEditingQuestion(null)
      setFormData({
        questionText: '',
        option1: '',
        option2: '',
        option3: '',
        option4: '',
        correctOption: 1,
        explanation: '',
        sectionId: filterSection || (sections[0]?.id || ''),
        topicId: '',
        difficultyLevel: 'medium',
        hasEquation: false,
        imageUrl: '',
        isActive: true,
      })
      // Load topics if section is selected
      const sectionId = filterSection || sections[0]?.id
      if (sectionId) {
        await fetchTopics(sectionId)
      }
    }
    setIsSheetOpen(true)
  }

  const handleCloseDialog = () => {
    setIsSheetOpen(false)
    setEditingQuestion(null)
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    
    // Validate required fields
    if (!formData.questionText || !formData.option1 || !formData.option2 || 
        !formData.option3 || !formData.option4 || !formData.sectionId) {
      toast({
        title: 'Validation Error',
        description: 'Please fill in all required fields',
        variant: 'destructive',
      })
      return
    }

    if (formData.correctOption < 1 || formData.correctOption > 4) {
      toast({
        title: 'Validation Error',
        description: 'Correct option must be between 1 and 4',
        variant: 'destructive',
      })
      return
    }

    setIsSubmitting(true)

    try {
      const url = editingQuestion
        ? `/api/admin/questions/${editingQuestion.id}`
        : '/api/admin/questions'
      const method = editingQuestion ? 'PUT' : 'POST'

      // Prepare data - convert empty strings to null for optional fields
      const submitData = {
        ...formData,
        topicId: formData.topicId || null,
        imageUrl: formData.imageUrl || null,
        explanation: formData.explanation || null,
      }

      const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(submitData),
      })

      if (!response.ok) {
        const error = await response.json()
        throw new Error(error.error || 'Failed to save question')
      }

      toast({
        title: 'Success',
        description: `Question ${editingQuestion ? 'updated' : 'created'} successfully`,
      })

      handleCloseDialog()
      fetchQuestions()
    } catch (error) {
      toast({
        title: 'Error',
        description: error instanceof Error ? error.message : 'Failed to save question',
        variant: 'destructive',
      })
    } finally {
      setIsSubmitting(false)
    }
  }

  const handleDelete = async (id: string) => {
    if (!confirm('Are you sure you want to delete this question?')) {
      return
    }

    try {
      const response = await fetch(`/api/admin/questions/${id}`, {
        method: 'DELETE',
      })

      if (!response.ok) throw new Error('Failed to delete question')

      toast({
        title: 'Success',
        description: 'Question deleted successfully',
      })

      fetchQuestions()
    } catch (error) {
      toast({
        title: 'Error',
        description: 'Failed to delete question',
        variant: 'destructive',
      })
    }
  }

  const getSectionName = (sectionId: string) => {
    return sections.find((s) => s.id === sectionId)?.name || 'Unknown'
  }

  const getTopicName = (topicId: string | null) => {
    if (!topicId) return '-'
    return topics.find((t) => t.id === topicId)?.name || 'Unknown'
  }

  const getDifficultyColor = (difficulty: string) => {
    switch (difficulty) {
      case 'easy':
        return 'bg-green-500'
      case 'medium':
        return 'bg-yellow-500'
      case 'hard':
        return 'bg-red-500'
      default:
        return 'bg-gray-500'
    }
  }

  const handleSectionChange = async (sectionId: string) => {
    setFormData({ ...formData, sectionId, topicId: '' })
    if (sectionId) {
      await fetchTopics(sectionId)
    } else {
      setTopics([])
    }
  }

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-3xl font-bold">Questions</h1>
          <p className="text-muted-foreground mt-2">
            Manage your question bank
          </p>
        </div>
        <div className="flex gap-2">
          <Link href="/admin/questions/import">
            <Button variant="outline">
              <Upload className="mr-2 h-4 w-4" />
              Import CSV
            </Button>
          </Link>
          <Button onClick={() => handleOpenDialog()} disabled={sections.length === 0}>
            <Plus className="mr-2 h-4 w-4" />
            Add Question
          </Button>
        </div>
      </div>

      <Card>
        <CardHeader>
          <div className="flex justify-between items-start">
            <div>
              <CardTitle>All Questions</CardTitle>
              <CardDescription>
                {total} question{total !== 1 ? 's' : ''} total
              </CardDescription>
            </div>
            <div className="flex gap-2">
              <Select value={filterSection || 'all'} onValueChange={(val) => setFilterSection(val === 'all' ? '' : val)}>
                <SelectTrigger className="w-[180px]">
                  <SelectValue placeholder="Filter by section" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">All Sections</SelectItem>
                  {sections.map((section) => (
                    <SelectItem key={section.id} value={section.id}>
                      {section.name}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
              <Select 
                value={filterTopic || 'all'} 
                onValueChange={(val) => setFilterTopic(val === 'all' ? '' : val)}
                disabled={!filterSection}
              >
                <SelectTrigger className="w-[180px]">
                  <SelectValue placeholder="Filter by topic" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">All Topics</SelectItem>
                  {topics.map((topic) => (
                    <SelectItem key={topic.id} value={topic.id}>
                      {topic.name}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
              <Select value={filterDifficulty || 'all'} onValueChange={(val) => setFilterDifficulty(val === 'all' ? '' : val)}>
                <SelectTrigger className="w-[150px]">
                  <SelectValue placeholder="Difficulty" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">All Levels</SelectItem>
                  <SelectItem value="easy">Easy</SelectItem>
                  <SelectItem value="medium">Medium</SelectItem>
                  <SelectItem value="hard">Hard</SelectItem>
                </SelectContent>
              </Select>
            </div>
          </div>
        </CardHeader>
        <CardContent>
          {isLoading ? (
            <div className="text-center py-8">Loading...</div>
          ) : sections.length === 0 ? (
            <div className="text-center py-8 text-muted-foreground">
              Please create a section first before adding questions.
            </div>
          ) : questions.length === 0 ? (
            <div className="text-center py-8 text-muted-foreground">
              No questions found. Create your first question to get started.
            </div>
          ) : (
            <>
              <Table>
                <TableHeader>
                  <TableRow>
                    <TableHead className="w-[40%]">Question</TableHead>
                    <TableHead>Section</TableHead>
                    <TableHead>Topic</TableHead>
                    <TableHead>Difficulty</TableHead>
                    <TableHead>Status</TableHead>
                    <TableHead className="text-right">Actions</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {questions.map((question) => (
                    <TableRow key={question.id}>
                      <TableCell className="max-w-md">
                        <div className="truncate" title={question.questionText}>
                          {question.questionText}
                        </div>
                        <div className="text-xs text-muted-foreground mt-1">
                          Correct: Option {question.correctOption}
                        </div>
                      </TableCell>
                      <TableCell>{getSectionName(question.sectionId)}</TableCell>
                      <TableCell>{getTopicName(question.topicId)}</TableCell>
                      <TableCell>
                        <Badge className={getDifficultyColor(question.difficultyLevel)}>
                          {question.difficultyLevel}
                        </Badge>
                      </TableCell>
                      <TableCell>
                        <Badge variant={question.isActive ? 'default' : 'secondary'}>
                          {question.isActive ? 'Active' : 'Inactive'}
                        </Badge>
                      </TableCell>
                      <TableCell className="text-right">
                        <div className="flex justify-end gap-2">
                          <Button
                            variant="ghost"
                            size="icon"
                            onClick={() => handleOpenDialog(question)}
                          >
                            <Pencil className="h-4 w-4" />
                          </Button>
                          <Button
                            variant="ghost"
                            size="icon"
                            onClick={() => handleDelete(question.id)}
                          >
                            <Trash2 className="h-4 w-4" />
                          </Button>
                        </div>
                      </TableCell>
                    </TableRow>
                  ))}
                </TableBody>
              </Table>

              {/* Pagination */}
              <div className="flex items-center justify-between mt-4">
                <div className="text-sm text-muted-foreground">
                  Page {currentPage} of {totalPages}
                </div>
                <div className="flex gap-2">
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setCurrentPage((p) => Math.max(1, p - 1))}
                    disabled={currentPage === 1}
                  >
                    <ChevronLeft className="h-4 w-4" />
                    Previous
                  </Button>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setCurrentPage((p) => Math.min(totalPages, p + 1))}
                    disabled={currentPage === totalPages}
                  >
                    Next
                    <ChevronRight className="h-4 w-4" />
                  </Button>
                </div>
              </div>
            </>
          )}
        </CardContent>
      </Card>

      <Sheet open={isSheetOpen} onOpenChange={setIsSheetOpen}>
        <SheetContent className="w-[50%] overflow-y-auto sm:max-w-none">
          <form onSubmit={handleSubmit} className="flex flex-col h-full">
            <SheetHeader className="mb-6">
              <SheetTitle>
                {editingQuestion ? 'Edit Question' : 'Create Question'}
              </SheetTitle>
              <SheetDescription>
                {editingQuestion
                  ? 'Update the question details below'
                  : 'Add a new question to your question bank'}
              </SheetDescription>
            </SheetHeader>
            <div className="flex-1 space-y-6 pb-6">
              <div className="space-y-2">
                <Label htmlFor="questionText">Question Text *</Label>
                <Textarea
                  id="questionText"
                  value={formData.questionText}
                  onChange={(e) =>
                    setFormData({ ...formData, questionText: e.target.value })
                  }
                  rows={3}
                  required
                />
              </div>

              <div className="space-y-4">
                <h3 className="text-sm font-semibold">Answer Options *</h3>
                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <Label htmlFor="option1">Option 1</Label>
                    <Input
                      id="option1"
                      value={formData.option1}
                      onChange={(e) =>
                        setFormData({ ...formData, option1: e.target.value })
                      }
                      required
                    />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="option2">Option 2</Label>
                    <Input
                      id="option2"
                      value={formData.option2}
                      onChange={(e) =>
                        setFormData({ ...formData, option2: e.target.value })
                      }
                      required
                    />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="option3">Option 3</Label>
                    <Input
                      id="option3"
                      value={formData.option3}
                      onChange={(e) =>
                        setFormData({ ...formData, option3: e.target.value })
                      }
                      required
                    />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="option4">Option 4</Label>
                    <Input
                      id="option4"
                      value={formData.option4}
                      onChange={(e) =>
                        setFormData({ ...formData, option4: e.target.value })
                      }
                      required
                    />
                  </div>
                </div>
              </div>

              <div className="space-y-2">
                <Label htmlFor="correctOption">Correct Option (1-4) *</Label>
                <Select
                  value={formData.correctOption.toString()}
                  onValueChange={(value) =>
                    setFormData({ ...formData, correctOption: parseInt(value) })
                  }
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="1">Option 1</SelectItem>
                    <SelectItem value="2">Option 2</SelectItem>
                    <SelectItem value="3">Option 3</SelectItem>
                    <SelectItem value="4">Option 4</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2">
                <Label htmlFor="explanation">Explanation (Optional)</Label>
                <Textarea
                  id="explanation"
                  value={formData.explanation}
                  onChange={(e) =>
                    setFormData({ ...formData, explanation: e.target.value })
                  }
                  rows={3}
                  placeholder="Provide an explanation for the correct answer..."
                />
              </div>

              <div className="space-y-4">
                <h3 className="text-sm font-semibold">Categorization</h3>
                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <Label htmlFor="sectionId">Section *</Label>
                    <Select
                      value={formData.sectionId}
                      onValueChange={handleSectionChange}
                      required
                    >
                      <SelectTrigger>
                        <SelectValue placeholder="Select a section" />
                      </SelectTrigger>
                      <SelectContent>
                        {sections.map((section) => (
                          <SelectItem key={section.id} value={section.id}>
                            {section.name}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="topicId">Topic (Optional)</Label>
                    <Select
                      value={formData.topicId || 'none'}
                      onValueChange={(value) =>
                        setFormData({ ...formData, topicId: value === 'none' ? '' : value })
                      }
                      disabled={!formData.sectionId}
                    >
                      <SelectTrigger>
                        <SelectValue placeholder="Select a topic" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="none">None</SelectItem>
                        {topics.map((topic) => (
                          <SelectItem key={topic.id} value={topic.id}>
                            {topic.name}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>
                </div>
              </div>

              <div className="space-y-4">
                <h3 className="text-sm font-semibold">Settings</h3>
                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <Label htmlFor="difficultyLevel">Difficulty</Label>
                    <Select
                      value={formData.difficultyLevel}
                      onValueChange={(value) =>
                        setFormData({
                          ...formData,
                          difficultyLevel: value as typeof formData.difficultyLevel,
                        })
                      }
                    >
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="easy">Easy</SelectItem>
                        <SelectItem value="medium">Medium</SelectItem>
                        <SelectItem value="hard">Hard</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="isActive">Status</Label>
                    <Select
                      value={formData.isActive.toString()}
                      onValueChange={(value) =>
                        setFormData({ ...formData, isActive: value === 'true' })
                      }
                    >
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="true">Active</SelectItem>
                        <SelectItem value="false">Inactive</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                </div>
              </div>

              <div className="space-y-2">
                <Label htmlFor="imageUrl">Image URL (Optional)</Label>
                <Input
                  id="imageUrl"
                  type="url"
                  value={formData.imageUrl}
                  onChange={(e) =>
                    setFormData({ ...formData, imageUrl: e.target.value })
                  }
                  placeholder="https://example.com/image.jpg"
                />
              </div>
            </div>
            <SheetFooter className="mt-6 gap-2">
              <Button
                type="button"
                variant="outline"
                onClick={handleCloseDialog}
              >
                Cancel
              </Button>
              <Button type="submit" disabled={isSubmitting}>
                {isSubmitting ? 'Saving...' : 'Save'}
              </Button>
            </SheetFooter>
          </form>
        </SheetContent>
      </Sheet>
    </div>
  )
}
